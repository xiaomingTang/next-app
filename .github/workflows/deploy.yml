name: Build and Deploy to Tencent COS

on:
  push:
    tags:
      - '*'

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-22.04
    
    env:
      STORE_PATH: ""
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        env:
          NODE_ENV: production
          NEXT_PUBLIC_LAST_COMMIT_MESSAGE: ${{ github.event.head_commit.message }}

          NEXT_PUBLIC_ORIGIN: ${{ secrets.NEXT_PUBLIC_ORIGIN }}
          NEXT_PUBLIC_PEER_SERVER: ${{ secrets.NEXT_PUBLIC_PEER_SERVER }}
          ANALYZE: ${{ secrets.ANALYZE }}
          SYSTEM_CONFIG_PEER_AUTH_REQUIRED: ${{ secrets.SYSTEM_CONFIG_PEER_AUTH_REQUIRED }}
          TTS_ENABLE_USER: ${{ secrets.TTS_ENABLE_USER }}
          TTS_ENABLE_GUEST: ${{ secrets.TTS_ENABLE_GUEST }}
          TTS_GUEST_CONCURRENCY: ${{ secrets.TTS_GUEST_CONCURRENCY }}
          TTS_USER_CONCURRENCY: ${{ secrets.TTS_USER_CONCURRENCY }}
          TTS_SECONDLY_CONCURRENCY: ${{ secrets.TTS_SECONDLY_CONCURRENCY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          PASSWORD_SALT: ${{ secrets.PASSWORD_SALT }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          MYSQLDB_URI: ${{ secrets.MYSQLDB_URI }}
          GA_ID: ${{ secrets.GA_ID }}
          NEXT_PUBLIC_CDN_ROOT: ${{ secrets.NEXT_PUBLIC_CDN_ROOT }}
          TC_COS_SECRET_ID: ${{ secrets.TC_COS_SECRET_ID }}
          TC_COS_SECRET_KEY: ${{ secrets.TC_COS_SECRET_KEY }}
          NEXT_PUBLIC_TC_COS_BUCKET: ${{ secrets.NEXT_PUBLIC_TC_COS_BUCKET }}
          NEXT_PUBLIC_TC_COS_REGION: ${{ secrets.NEXT_PUBLIC_TC_COS_REGION }}
          DINGTALK_ACCESS_TOKEN: ${{ secrets.DINGTALK_ACCESS_TOKEN }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
          STUN_SERVER: ${{ secrets.STUN_SERVER }}
          TURN_SERVER: ${{ secrets.TURN_SERVER }}
          TURN_SECRET: ${{ secrets.TURN_SECRET }}
          NEXT_PUBLIC_CYBER_BEGGER_ADDRESS: ${{ secrets.NEXT_PUBLIC_CYBER_BEGGER_ADDRESS }}

        run: pnpm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            .next/
            public/
            launch.sh
            .ssl/
            .bak/
            ci/
          retention-days: 1

  package:
    name: Create Deployment Package
    runs-on: ubuntu-22.04
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Create deployment archive
        run: |
          echo "üî® Creating deployment archive..."
          
          # ÂàõÂª∫ÈÉ®ÁΩ≤ÁõÆÂΩïÁªìÊûÑÔºåÂèÇËÄÉ Dockerfile
          mkdir -p deploy-package
          
          # Ê£ÄÊü•ÂøÖÈúÄÁöÑÊûÑÂª∫‰∫ßÁâ©
          if [ ! -d ".next/standalone" ]; then
            echo "‚ùå Error: .next/standalone directory not found"
            exit 1
          fi
          
          if [ ! -d ".next/static" ]; then
            echo "‚ùå Error: .next/static directory not found"
            exit 1
          fi
          
          # Â§çÂà∂ÂøÖË¶ÅÁöÑÊñá‰ª∂ÂíåÁõÆÂΩï (ÂèÇËÄÉ Dockerfile ÁöÑ runner Èò∂ÊÆµ)
          echo "üìÅ Copying .next/standalone/*"
          cp -r .next/standalone/* deploy-package/
          
          echo "üìÅ Creating .next/static directory"
          mkdir -p deploy-package/.next/static
          cp -r .next/static/* deploy-package/.next/static/
          
          echo "üìÅ Copying public directory"
          cp -r public deploy-package/
          
          # Â¶ÇÊûúÂ≠òÂú®Ëøô‰∫õÊñá‰ª∂/ÁõÆÂΩïÂàôÂ§çÂà∂ (ÂèØÈÄâ)
          if [ -f launch.sh ]; then
            echo "üìÅ Copying launch.sh"
            cp launch.sh deploy-package/
          fi
          
          if [ -d .ssl ]; then
            echo "üìÅ Copying .ssl directory"
            cp -r .ssl deploy-package/
          fi
          
          if [ -d .bak ]; then
            echo "üìÅ Copying .bak directory"
            cp -r .bak deploy-package/
          fi
          
          if [ -d ci ]; then
            echo "üìÅ Copying ci directory"
            cp -r ci deploy-package/
          fi
          
          # ÂàõÂª∫ÂéãÁº©ÂåÖ
          echo "üóúÔ∏è Creating archive..."
          cd deploy-package
          tar -czf ../app.tar.gz .
          cd ..
          
          # ÊòæÁ§∫ÂéãÁº©ÂåÖ‰ø°ÊÅØ
          FILE_SIZE=$(ls -lh app.tar.gz | awk '{print $5}')
          echo "‚úÖ Deploy package created: app.tar.gz (Size: $FILE_SIZE)"
          
          # ÊòæÁ§∫ÂéãÁº©ÂåÖÂÜÖÂÆπÊ¶ÇËßà
          echo "üì¶ Archive contents:"
          tar -tzf app.tar.gz | head -20
          if [ $(tar -tzf app.tar.gz | wc -l) -gt 20 ]; then
            echo "... and $(expr $(tar -tzf app.tar.gz | wc -l) - 20) more files"
          fi

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: app.tar.gz
          retention-days: 1

  upload:
    name: Upload to Tencent COS
    runs-on: ubuntu-22.04
    needs: package
    
    env:
      COS_OBJECT_KEY: ""
      TAG_NAME: ""
      TIMESTAMP: ""
    
    steps:
      - name: Setup deployment variables
        run: |
          # Ëé∑ÂèñÂΩìÂâç tag ÂêçÁß∞
          TAG_NAME=${GITHUB_REF#refs/tags/}
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          OBJECT_KEY="releases/${TAG_NAME}_${TIMESTAMP}/app.tar.gz"
          
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "COS_OBJECT_KEY=$OBJECT_KEY" >> $GITHUB_ENV
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package

      - name: Upload to Tencent COS
        uses: TencentCloud/cos-action@v1
        with:
          secret_id: ${{ secrets.TC_COS_SECRET_ID }}
          secret_key: ${{ secrets.TC_COS_SECRET_KEY }}
          cos_bucket: ${{ secrets.NEXT_PUBLIC_TC_COS_BUCKET }}
          cos_region: ${{ secrets.NEXT_PUBLIC_TC_COS_REGION }}
          local_path: ./app.tar.gz
          remote_path: ${{ env.COS_OBJECT_KEY }}
          clean: false

      - name: Log deployment info
        run: |
          echo "üìä Deployment Summary"
          echo "===================="
          echo "üè∑Ô∏è  Tag: $TAG_NAME"
          echo "üì¶ COS Object: $COS_OBJECT_KEY"
          echo "üïê Timestamp: $TIMESTAMP"
          echo "üìÅ Repository: $GITHUB_REPOSITORY"
          echo "üîó Commit: $GITHUB_SHA"
          echo "‚úÖ Build and upload completed successfully!"

  deploy:
    name: Deploy Application
    runs-on: ubuntu-22.04
    needs: upload
    
    env:
      COS_OBJECT_KEY: ""
      TAG_NAME: ""
    
    steps:
      - name: Setup deployment variables
        run: |
          # Ëé∑ÂèñÂΩìÂâç tag ÂêçÁß∞
          TAG_NAME=${GITHUB_REF#refs/tags/}
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          OBJECT_KEY="releases/${TAG_NAME}_${TIMESTAMP}/app.tar.gz"
          
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "COS_OBJECT_KEY=$OBJECT_KEY" >> $GITHUB_ENV

      - name: Call deployment webhook
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          COS_OBJECT_KEY: ${{ env.COS_OBJECT_KEY }}
          TAG_NAME: ${{ env.TAG_NAME }}
        run: |
          echo "üîó Calling deployment webhook..."
          
          # ÂáÜÂ§á webhook ËΩΩËç∑
          PAYLOAD=$(cat << EOF
          {
            "event": "deploy",
            "tag": "$TAG_NAME",
            "cos_object_key": "$COS_OBJECT_KEY",
            "repository": "$GITHUB_REPOSITORY",
            "commit_sha": "$GITHUB_SHA",
            "commit_message": "${{ github.event.head_commit.message }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          )
          
          echo "üìã Webhook payload:"
          echo "$PAYLOAD" | jq '.'
          
          # Ë∞ÉÁî®ÈÉ®ÁΩ≤ webhook
          HTTP_CODE=$(curl -w "%{http_code}" -o webhook_response.txt -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions/$GITHUB_RUN_ID" \
            -H "X-GitHub-Event: deployment" \
            -H "X-GitHub-Repository: $GITHUB_REPOSITORY" \
            -H "X-GitHub-Ref: $GITHUB_REF" \
            -d "$PAYLOAD" \
            --connect-timeout 30 \
            --max-time 120)
          
          echo "üåê HTTP Response Code: $HTTP_CODE"
          
          if [ -f webhook_response.txt ]; then
            echo "üìÑ Webhook Response:"
            cat webhook_response.txt
          fi
          
          # Ê£ÄÊü•ÂìçÂ∫îÁä∂ÊÄÅ
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Webhook called successfully"
          else
            echo "‚ö†Ô∏è  Webhook call returned HTTP $HTTP_CODE, but continuing..."
            echo "This might indicate an issue with the webhook endpoint."
          fi

  cleanup:
    name: Cleanup Artifacts
    runs-on: ubuntu-22.04
    needs: [build, package, upload, deploy]
    if: always()
    
    steps:
      - name: Delete artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            build-artifacts
            deployment-package
        continue-on-error: true
